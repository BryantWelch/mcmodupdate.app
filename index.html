<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MC Mod Updater | Update Your Minecraft Mods</title>
    <meta name="description" content="Easily update your Minecraft mods or build a new modpack from scratch. Upload your .jar files or search for mods on Modrinth to find the latest compatible versions and dependencies.">
    <meta name="keywords" content="Minecraft, Mod, Updater, Modpack, Builder, Modrinth, Fabric, Forge, NeoForge, Quilt, Update, Minecraft Mods">
    <meta name="author" content="Bryant Welch">
    <link rel="canonical" href="https://mcmodupdate.app/">
    
    <!-- Favicon and Theme Configuration -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <meta name="msapplication-TileColor" content="#6366f1">
    <meta name="theme-color" content="#11101d">

    <!-- Open Graph / Social Media Tags -->
    <meta property="og:title" content="MC Updater | Update & Build Minecraft Modpacks">
    <meta property="og:description" content="A powerful web tool to update existing mods and discover new ones via the Modrinth API.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mcmodupdate.app/">
    <meta property="og:image" content="https://mcmodupdate.app/social-preview.png">
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/toml-js@0.0.8/lib/amd/toml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
      
      /* -- CSS -- */
      :root {
        --bg-color: #11101d;
        --card-bg: #1e1e2f;
        --primary-text: #e0e0e0;
        --secondary-text: #a0a0a0;
        --border-color: #4a4a5e;
        --dropzone-bg: rgba(255, 255, 255, 0.05);
        --dropzone-hover-bg: rgba(255, 255, 255, 0.1);
        --pill-bg: #2a2a3a;
        --gradient-start: #a855f7;
        --gradient-end: #6366f1;
        --success-color: #4caf50;
        --error-color: #f44336;
        --warning-color: #ffc107;
        --alpha-color: #ef5350;
        --beta-color: #ff9800;
      }
      html,
      body {
        width: 100%;
        overflow-x: hidden;
      }
      body {
        background-color: var(--bg-color);
        color: var(--primary-text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: 100vh;
        padding: 2rem 0 0 0;
        box-sizing: border-box;
      }
      .main-container {
        width: 100%;
        max-width: 800px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
        flex-grow: 1;
        padding: 0 1rem;
      }
      h1 {
        font-size: 3rem;
        margin-bottom: 0.5rem;
        font-weight: bold;
        background: linear-gradient(
          to right,
          var(--gradient-start),
          var(--gradient-end)
        );
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 0;
      }
      .subtitle {
        color: var(--secondary-text);
        margin-top: 0;
      }
      .controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1.5rem;
      }
      select {
        background-color: var(--bg-color);
        color: var(--primary-text);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 0.5rem 1rem;
        font-size: 1rem;
        transition: background-color 0.2s ease, border-color 0.2s ease;
      }
      select:hover {
        border-color: var(--gradient-start);
      }
      .dropzone {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        max-width: 400px;
        height: 150px;
        margin-left: auto;
        margin-right: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        transition: all 0.3s ease;
        background-color: var(--dropzone-bg);
        cursor: pointer;
        overflow: hidden;
      }
      .dropzone.dropzone-expanded {
        max-width: 100%;
        min-height: 120px;
        height: auto;
      }
      .dropzone:hover,
      .dropzone.dragover {
        background-color: var(--dropzone-hover-bg);
        border-color: var(--gradient-start);
      }
      .dropzone-prompt {
        color: var(--secondary-text);
      }
      .file-list {
        display: flex;
        gap: 0.75rem;
        width: 100%;
        overflow-x: auto;
        padding-bottom: 1.5rem;
        scrollbar-width: auto;
        scrollbar-color: var(--border-color) rgba(255, 255, 255, 0.03);
      }
      .file-list::-webkit-scrollbar {
        height: 12px;
      }
      .file-list::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 4px;
      }
      .file-list::-webkit-scrollbar-thumb {
        background-color: var(--border-color);
        border-radius: 4px;
      }
      .file-list::-webkit-scrollbar-thumb:hover {
        background-color: var(--gradient-start);
      }
      .file-pill {
        background-color: var(--pill-bg);
        padding: 0.5rem 1rem;
        padding-right: 28px;
        border-radius: 1rem;
        white-space: nowrap;
        font-size: 0.9rem;
        position: relative;
        display: inline-flex;
        align-items: center;
      }
      .file-pill span {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
      }
      .file-pill-remove {
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        cursor: pointer;
        font-size: 1.4rem;
        line-height: 1;
        color: var(--secondary-text);
      }
      .file-pill-remove:hover {
        color: var(--primary-text);
      }
      .update-button {
        background: linear-gradient(
          to right,
          var(--gradient-start),
          var(--gradient-end)
        );
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.6rem 0.5rem;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: transform 0.15s ease;
        max-width: 160px;
      }
      .update-button:hover {
        transform: scale(1.05);
      }
      .update-button:disabled {
        background: var(--border-color);
        cursor: not-allowed;
        transform: none;
      }

      .action-buttons-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
      }

      .clear-all-button {
        background-color: transparent;
        color: var(--secondary-text);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
        display: none; /* Hidden by default */
      }

      .clear-all-button:hover {
        background-color: var(--pill-bg);
        color: var(--primary-text);
        border-color: var(--primary-text);
      }

      #scroll-buttons-container {
        position: fixed;
        bottom: 4.5rem;
        right: 2rem;
        z-index: 100;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .scroll-btn {
        width: 48px;
        height: 48px;
        background-color: var(--card-bg);
        color: var(--primary-text);
        border: 1px solid var(--border-color);
        border-radius: 50%;
        cursor: pointer;
        display: none; /* Hidden by default */
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        opacity: 0.7;
      }

      .scroll-btn:hover {
        opacity: 1;
        transform: scale(1.1);
        background-color: var(--gradient-start);
        border-color: var(--gradient-start);
      }
      .info-button {
        position: absolute;
        top: 0;
        right: 0;
        width: 60px;
        height: 60px;
        background: var(--gradient-end);
        border: none;
        padding: 0;
        cursor: pointer;
        clip-path: polygon(0% 0%, 100% 0%, 100% 100%);
        border-radius: 0;
      }
      .info-button svg {
        position: absolute;
        top: 8px;
        right: 8px;
        stroke: white;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: opacity 0.3s ease-in-out;
        opacity: 0; /* Start transparent */
        pointer-events: none; /* Prevent interaction when hidden */
      }
      #search-modal {
        align-items: flex-start; /* Aligns content to the top */
        padding-top: 15vh; /* Adds space from the top */
      }
      .modal-overlay.visible {
        opacity: 1; /* Fade in to full opacity */
        pointer-events: auto; /* Allow interaction when visible */
      }
      .modal-content {
        background-color: #1e1e2f;
        padding: 2rem;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        position: relative;
        color: var(--secondary-text);
        transform: scale(0.95);
        transition: transform 0.3s ease-in-out;
      }
      .modal-overlay.visible .modal-content {
        transform: scale(1);
      }
      .modal-actions {
        text-align: center;
        margin-top: 1rem;
      }
      .modal-close-button {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 2rem;
        color: var(--secondary-text);
        cursor: pointer;
        line-height: 1;
      }
      .modal-close-button:hover {
        color: var(--primary-text);
      }
      #alert-icon {
        display: inline-block;
        margin-right: 0.75rem;
        vertical-align: middle;
      }
      footer {
        width: 100%;
        background-color: #0c0c17;
        color: var(--secondary-text);
        padding: 0rem 0 0.5rem 0;
        font-size: 0.9rem;
        margin-top: 3rem;
      }
      .footer-content {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 1rem;
        max-width: 900px;
        margin: 0 auto 1rem auto;
        padding: 0 1rem;
        text-align: left;
      }
      .footer-column h4 {
        color: var(--primary-text);
        font-size: 1.5rem;
        margin-bottom: 1rem;
        font-weight: 600;
      }
      .footer-column ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .footer-column ul li {
        margin-bottom: 0.6rem;
      }
      .footer-column ul li a {
        color: var(--secondary-text);
        text-decoration: none;
        transition: color 0.2s ease;
      }
      .footer-column ul li a:hover {
        color: var(--primary-text);
        text-decoration: underline;
      }
      .footer-bottom {
        text-align: center;
        padding: 1.2rem 1rem 0.6rem;
        border-top: 1px solid var(--border-color);
        font-size: 0.85rem;
        position: relative;
      }
      .footer-bottom p {
        margin: 0;
      }
      .footer-bottom p a {
        color: var(--secondary-text);
        text-decoration: underline;
        transition: color 0.2s ease;
      }
      .footer-bottom p a:hover {
        color: var(--primary-text);
      }
      .kofi-button {
        position: absolute;
        right: 1rem;
        top: 55%;
        margin-top: -18px;
        transition: transform 0.15s ease;
      }
      .kofi-button:hover {
        transform: scale(1.05);
      }
      .kofi-button img {
        height: 36px;
        width: auto;
        border-radius: 6px;
      }
      .progress-bar-container {
        width: 100%;
        background-color: var(--card-bg);
        border-radius: 4px;
        margin-top: 1rem;
        display: none; /* Hidden by default */
      }
      .progress-bar {
        width: 0%;
        height: 10px;
        background: linear-gradient(
          to right,
          var(--gradient-start),
          var(--gradient-end)
        );
        border-radius: 4px;
        transition: width 0.3s ease-out;
      }
      .status-message {
        color: var(--secondary-text);
        font-size: 0.9rem;
        margin: 0; /* Margin will be part of the transition */
        max-height: 0; /* Start with zero height */
        opacity: 0; /* Start fully transparent */
        overflow: hidden; /* Important for the max-height trick */
        transition: all 0.2s ease-in-out; /* Animate everything */
      }
      .status-message.visible {
        margin-top: 0.5rem; /* Add margin when visible */
        max-height: 4em; /* Animate to a height large enough for 2-line text */
        opacity: 1; /* Animate to be fully visible */
      }
      #results-area {
        width: 100%;
        margin-top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }
      .results-section {
        display: none; /* Hidden by default */
      }
      .results-section.visible {
        display: block;
      }
      .results-section h2 {
        text-align: left;
        color: var(--primary-text);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
      }
      .results-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .result-card {
        background-color: var(--card-bg);
        border-radius: 8px;
        padding: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        text-align: left;
      }
      .result-card-main {
        display: flex;
        gap: 1rem;
        width: 100%;
      }
      .result-card.failure,
      .result-card.warning {
        align-items: center;
      }
      .result-card.failure {
        border-left: 4px solid var(--error-color);
      }
      .result-card.warning {
        border-left: 4px solid var(--warning-color);
      }
      .mod-icon-link {
        flex-shrink: 0;
      }
      .mod-icon {
        width: 64px;
        height: 64px;
        border-radius: 8px;
        object-fit: cover;
        background-color: var(--bg-color);
      }
      .mod-details {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        min-width: 0;
      }
      .mod-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--primary-text);
      }
      .mod-title a {
        color: inherit;
        text-decoration: none;
      }
      .mod-title a:hover {
        text-decoration: underline;
      }
      .mod-author {
        font-size: 0.9rem;
        font-weight: normal;
        color: var(--secondary-text);
      }
      .mod-author a {
        color: var(--secondary-text);
        text-decoration: none;
      }
      .mod-author a:hover {
        text-decoration: underline;
      }
      .mod-description {
        font-size: 0.9rem;
        color: var(--secondary-text);
        margin-top: 0.25rem;
      }
      .mod-meta {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        font-size: 0.85rem;
        color: var(--secondary-text);
        margin-top: 0.5rem;
      }
      .mod-meta-item {
        display: flex;
        align-items: center;
        gap: 0.3rem;
      }
      /* --- Category Tooltip Styles --- */
      .category-tooltip-container {
        position: relative; /* This is crucial for positioning the tooltip */
        display: flex;
        align-items: center;
      }

      .category-tooltip {
        visibility: hidden; /* Hide the tooltip by default */
        opacity: 0;
        transition: opacity 0.2s ease;

        position: absolute;
        bottom: 125%; /* Position it above the icon */
        left: 50%;
        transform: translateX(-50%); /* Center it horizontally */

        background-color: var(--card-bg);
        color: var(--primary-text);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        z-index: 10;

        white-space: nowrap; /* Keep the tooltip on a single line */
        font-size: 0.85rem;
      }

      /* Show the tooltip when hovering over the container */
      .category-tooltip-container:hover .category-tooltip {
        visibility: visible;
        opacity: 1;
      }
      .changelog-toggle {
        cursor: pointer;
        text-decoration: underline;
      }
      .changelog-toggle:hover {
        color: var(--primary-text);
      }
      .mod-channel-links {
        display: flex;
        align-items: center;
      }

      .channel-link {
        text-decoration: underline;
        cursor: pointer;
        transition: color 0.2s ease;
      }

      /* Match the hover effect of the changelog link */
      .channel-link:hover {
        color: var(--primary-text);
      }

      /* Set the specific text colors for each channel */
      .channel-link.release {
        color: var(--success-color);
      }
      .channel-link.beta {
        color: var(--beta-color);
      }
      .channel-link.alpha {
        color: var(--alpha-color);
      }
      .changelog-content {
        display: none;
        width: 100%;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
        color: var(--secondary-text);
        font-size: 0.9rem;
      }
      .changelog-content.visible {
        display: block;
      }
      .changelog-content ul {
        padding-left: 20px;
        margin: 0;
      }
      .mod-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 1rem;
        flex-shrink: 0;
      }
      .version-select {
        background-color: var(--pill-bg);
        border: 1px solid var(--border-color);
        color: var(--primary-text);
        border-radius: 6px;
        padding: 0.3rem 0.5rem;
        width: clamp(100px, 25vw, 140px);
        white-space: nowrap; /* Prevents the text inside from wrapping */
        overflow: hidden; /* Hides the text that overflows the container */
        text-overflow: ellipsis; /* Adds the "..." for any hidden text */
      }
      .version-type {
        font-weight: bold;
        margin-left: 0.5em;
      }
      .version-type-release {
        color: var(--success-color);
      }
      .version-type-beta {
        color: var(--beta-color);
      }
      .version-type-alpha {
        color: var(--alpha-color);
      }
      .download-link {
        background-color: var(--success-color);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        text-decoration: none;
        font-weight: bold;
        font-size: 0.9rem;
      }
      .results-actions {
        display: flex;
        justify-content: center;
        align-items: flex-start; /* Aligns the tops of the buttons */
        gap: 1rem;
        margin-top: 1rem;
      }
      .action-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.6rem 1.2rem;
        background: linear-gradient(
          to right,
          var(--gradient-start),
          var(--gradient-end)
        );
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 1rem;
        transition: transform 0.15s ease;
      }
      .action-button:hover {
        transform: scale(1.05);
      }
      .search-container {
        position: relative;
        display: flex;
        align-items: center;
      }
      .search-container input {
        background-color: var(--bg-color);
        color: var(--primary-text);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 0.5rem 1rem;
        padding-right: 2.5rem;
        font-size: 1rem;
        transition: border-color 0.2s ease;
        margin-left: 0.3rem;
      }
      .search-container input:focus {
        outline: none;
        border-color: var(--gradient-start);
      }
      .search-clear-button {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--secondary-text);
        font-size: 1.5rem;
        cursor: pointer;
        display: none; /* Hidden by default */
        padding: 0 0.5rem;
        line-height: 1;
      }
      .search-clear-button:hover {
        color: var(--primary-text);
      }

      #search-results-container {
        margin-top: 1.5rem;
        max-height: 60vh;
        overflow-y: auto;
        padding-right: 0.5rem; /* For scrollbar spacing */
      }

      /* Style for the "Add" button on search result cards */
      .add-mod-button {
        background-color: var(--success-color);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        text-decoration: none;
        font-weight: bold;
        font-size: 0.9rem;
        border: none;
        cursor: pointer;
      }
      .add-mod-button:disabled {
        background-color: var(--border-color);
        cursor: not-allowed;
      }

/* -- Styles for the header and the toggle button's container -- */
.results-header-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border-color);
  padding-bottom: 0.5rem;
  margin-bottom: 1rem;
}

.results-header-container h2 {
  border-bottom: none;
  padding-bottom: 0;
  margin-bottom: 0;
}

/* -- Styles for the layout toggle button itself -- */
.layout-toggle {
  background: transparent;
  border: 1px solid var(--border-color);
  color: var(--secondary-text);
  border-radius: 6px;
  cursor: pointer;
  padding: 0.3rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.layout-toggle:hover {
  color: var(--primary-text);
  border-color: var(--primary-text);
  background-color: var(--pill-bg);
}

/* -- Default Visibility: Hide grid-only elements -- */
.grid-view-channels {
  display: none;
}

/* -- Grid View Container Style -- */
.results-list.grid-view {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1rem;
}

/* -- Card Styles in Grid View -- */
.results-list.grid-view .result-card {
  flex-direction: column;
  padding: 0.75rem;
  align-items: center;
  text-align: center;
  gap: 0.5rem;
}

.results-list.grid-view .result-card-main {
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
}

/* -- Child Element Styles in Grid View -- */
.results-list.grid-view .mod-icon {
  width: 64px;
  height: 64px;
}

.results-list.grid-view .mod-title {
  font-size: 1rem;
  font-weight: 600;
  line-height: 1.3;
  height: 2.6em; /* Reserve space for 2 lines */
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Hide elements not needed in compact view */
.results-list.grid-view .mod-author,
.results-list.grid-view .mod-description,
.results-list.grid-view .mod-meta {
  display: none;
}

/* -- Action Area in Grid View -- */
.results-list.grid-view .mod-actions {
  width: 100%;
  margin-top: auto;
  padding-top: 0.5rem;
  border-top: 1px solid var(--border-color);
  align-items: stretch;
  gap: 0.5rem;
}

.results-list.grid-view .version-select {
  text-align: center;
  padding: 0.2rem 0.5rem;
  margin-left: auto;
  margin-right: auto;
}

/* -- New Bottom Line Container -- */
.results-list.grid-view .grid-bottom-line {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.85rem;
}

.results-list.grid-view .grid-view-channels {
  display: block;
}

.results-list.grid-view .download-link {
  background: none;
  padding: 0;
  font-weight: normal;
  color: var(--secondary-text);
  text-decoration: underline;
}

.results-list.grid-view .download-link:hover {
  color: var(--primary-text);
}

/* This new class will style ALL tags */
.mod-title-tag {
  font-size: 0.9rem;
  font-weight: normal;
  color: var(--secondary-text); /* Matches the author text color */
  margin-left: 0.5rem;
  font-style: italic;
  white-space: nowrap; /* Prevents the tag itself from breaking onto two lines */
}

/* Dependency tag specific styling - same pattern as category tooltip */
.dependency-tooltip-container {
  position: relative;
  display: inline-flex;
  align-items: center;
}

.dependency-tag {
  /* Use the same styling as the base mod-title-tag */
  font-size: 0.9rem;
  font-weight: normal;
  color: var(--secondary-text);
  margin-left: 0.5rem;
  font-style: italic;
  white-space: nowrap;
  cursor: help;
}

.dependency-tooltip {
  visibility: hidden;
  opacity: 0;
  transition: opacity 0.2s ease;
  
  position: absolute;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  
  background-color: var(--card-bg);
  color: var(--primary-text);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 0.5rem 0.75rem;
  z-index: 10;
  
  white-space: nowrap;
  font-size: 0.85rem;
}

.dependency-tooltip-container:hover .dependency-tooltip {
  visibility: visible;
  opacity: 1;
}

/* --- Begin Mobile Responsive Styles --- */
@media (max-width: 700px) {
  /* Make the main container use the full width */
  .main-container {
    padding: 0 1rem;
  }

  /* Reduce header size */
  h1 {
    font-size: 2.2rem;
  }

  /* --- 1. Stack the main controls vertically --- */
  .controls {
    flex-direction: column;
    align-items: stretch; /* Make all control groups full-width */
    gap: 1rem;
  }

  .control-group {
    display: flex;
    flex-direction: column; /* Stack label above the input/select */
    align-items: flex-start;
    gap: 0.25rem;
  }

  /* Make inputs and selects full-width */
  .search-container input,
  .control-group select {
    width: 100%;
    box-sizing: border-box;
  }

  /* Make Update/Clear buttons full width */
  .action-buttons-container {
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 400px;
    gap: 1rem; /* Add a gap for nice spacing when both buttons are visible */
  }

  /* Center the welcome message content */
  #welcome-message h2,
  #welcome-message p {
    text-align: center;
  }

  /* --- Stack the result card content --- */
  .result-card-main {
    flex-direction: column;
    align-items: center; /* Center the icon */
    gap: 0.5rem;
  }

  .mod-details,
  .mod-actions {
    width: 100%; /* Allow details and actions to take full width */
    align-items: center; /* Makes dropdown/button full width */
  }

  .mod-details {
    text-align: center; /* Center the text below the icon */
  }

  .mod-meta {
    justify-content: center; /* Center the metadata items */
    margin-top: 1rem;
  }

  /* --- Fix the Footer Layout --- */
  .footer-content {
    flex-direction: column; /* Stack the columns vertically */
    text-align: center; /* Center the text inside each column */
    gap: 2rem; /* Add more space between the stacked sections */
  }

  .footer-bottom {
    display: flex;
    flex-direction: column; /* Stack the copyright and Ko-fi button */
    align-items: center;
    gap: 1rem;
    padding-top: 1.5rem;
  }

  .kofi-button {
    position: static; /* Remove absolute positioning */
    transform: none; /* Reset the transform */
    margin-top: 0.5rem; /* Add some space above it */
  }
}
/* --- End of Mobile Responsive Styles --- */

/* --- Download Button Styles --- */
  .download-button-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem; /* Creates a small space between the button and the text below it */
}

  .download-size-info {
    font-size: 0.7rem;
    margin-top: 0.15rem;
    color: var(--secondary-text);
}
/* --- End of CSS */

/* Beginning of HTML */
    </style>
  </head>
  <body>
    <button id="info-button" class="info-button" aria-label="Show info">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="16" x2="12" y2="12"></line>
        <line x1="12" y1="8" x2="12.01" y2="8"></line>
      </svg>
    </button>
    <div class="main-container">
      <header>
        <h1>Minecraft Mod Updater</h1>
        <p class="subtitle">
          Easily find updates for your Minecraft Mods using the Modrinth API
        </p>
      </header>
      <div class="controls">
        <div class="control-group">
          <label for="mod-loader">Loader:</label>
          <select id="mod-loader">
            <option value="fabric">Fabric</option>
            <option value="forge">Forge</option>
            <option value="neoforge">NeoForge</option>
            <option value="quilt">Quilt</option>
          </select>
        </div>
        <div class="control-group">
          <label for="mc-version">Version:</label>
          <select id="mc-version"></select>
        </div>
        <div class="control-group search-container">
          <label for="mod-search">Search:</label>
          <input type="text" id="mod-search" placeholder="Find mods by name...">
          <button id="search-clear-button" class="search-clear-button">&times;</button>
        </div>
      </div>
      <div id="dropzone" class="dropzone">
        <div id="file-list-container" class="file-list"></div>
        <p id="dropzone-prompt" class="dropzone-prompt">
          Upload your mod files (.jar),
          <br />
          Upload a modpack (.mrpack)
          <br />
          or use the search
        </p>
      </div>
      <div class="action-buttons-container">
        <button id="update-button" class="update-button">
          Update
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
        </button>
        <button id="clear-all-button" class="clear-all-button">
          Clear Input
        </button>
        <button
          id="clear-results-button"
          class="clear-all-button"
          style="display: none"
        >
          Clear Results
        </button>
      </div>
      <div id="progress-bar-container" class="progress-bar-container">
        <div id="progress-bar" class="progress-bar"></div>
      </div>
      <p id="status-message" class="status-message"></p>
      <div id="results-area">
        <div id="welcome-message" class="results-section visible">
          <h2 style="text-align: center">
            Welcome to the Minecraft Mod Updater &amp; Builder!
          </h2>
          <p style="text-align: left; line-height: 1.6">
            This tool is your one-stop shop for managing your Minecraft mods. You can
            easily find updates for your entire mod list, discover new mods, and
            export a ready-to-use modpack for your favorite launcher.
          </p>
          <h3 style="text-align: center; margin-top: 2rem">Ready to Start?</h3>
          <p style="text-align: left; line-height: 1.6">
            To get started, you can upload an entire modpack
            <code>.mrpack</code> to update it, drag and drop your individual
            <code>.jar</code> files, or use the search bar to find new mods. Then,
            click the "Update" button to see the magic happen!
          </p>
          <p
            style="
              text-align: left;
              font-style: italic;
              margin-top: 2rem;
              font-size: 0.9rem;
              color: var(--secondary-text);
            "
          >
            For more detailed instructions, click the info icon in the top-right
            corner.
          </p>
        </div>
      </div>
    </div>
    <input
      type="file"
      id="file-input"
      multiple
      style="display: none"
      accept=".jar,.mrpack"
    />

    <!-- Info Modal -->
    <div id="info-modal" class="modal-overlay">
      <div class="modal-content">
        <button id="modal-close-button" class="modal-close-button">&times;</button>
        
        <h2>MC Mod Updater &amp; Builder</h2>
        <p>
          This tool helps you update your existing Minecraft mods or build a brand new mod list from scratch. It uses the Modrinth API to find the latest compatible versions and can export your list as a standard Modrinth modpack.
        </p>
        <h3>How to use:</h3>
        <ul>
          <li>
            Select your desired mod loader (Fabric, Forge, etc.) and the target
            Minecraft version you want to update to.
          </li>
          <li>
            <b>Update a Modpack:</b> Upload a <code>.mrpack</code> file to load its
            entire mod list for updating.
          </li>
          <li>
            <b>Update Individual Mods:</b> Drag and drop your local <code>.jar</code>
            files into the upload area.
          </li>
          <li>
            <b>Discover New Mods:</b> Use the search bar to find and add mods directly
            from Modrinth.
          </li>
          <li><b>Process Your List:</b> Click the "Update" button.</li>
          <li>
            <b>Get Results:</b> The tool will find the latest compatible versions and
            automatically add any required dependencies for you.
          </li>
        </ul>
        <h3>Attributions:</h3>
        <p>
          This tool relies on the Modrinth API for all mod data. Please be aware of their ratelimits. The ratelimit is currently 300 requests per minute. The application will automatically pause and resume to respect these limits.
        </p>
      </div>
    </div>

    <!-- ALERT MODAL BLOCK -->
    <div id="alert-modal" class="modal-overlay">
      <div class="modal-content">
        <h2 id="alert-title"><span id="alert-icon"></span>Notice</h2>
        <p id="alert-message" style="margin: 1.5rem 0;"></p>
        <div class="modal-actions">
          <button id="alert-ok-button" class="action-button">OK</button>
        </div>
      </div>
    </div>

    <!-- SEARCH MODAL BLOCK -->
    <div id="search-modal" class="modal-overlay">
      <div class="modal-content">
        <button id="search-x-close-button" class="modal-close-button">&times;</button>
        
        <h2 id="search-title">Search for Mods</h2>
        <div id="search-results-container">
          <p>Start typing in the search bar to find mods.</p>
        </div>
        <div class="modal-actions">
          <button id="search-close-button" class="clear-all-button">Close</button>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <footer>
      <div class="footer-content">
        <div class="footer-column">
          <h4>About</h4>
          <ul>
            <li>
              <a
                href="https://github.com/BryantWelch/mcmodupdate.app"
                target="_blank"
                rel="noopener noreferrer"
                >GitHub Repository</a
              >
            </li>
            <li>
              <a
                href="https://github.com/BryantWelch/mcmodupdate.app/issues"
                target="_blank"
                rel="noopener noreferrer"
                >Report an Issue</a
              >
            </li>
            <li>
              <a
                href="https://github.com/BryantWelch/mcmodupdate.app/blob/main/CONTRIBUTING.md"
                target="_blank"
                rel="noopener noreferrer"
                >Contribute</a
              >
            </li>
            <li>
              <a
                href="https://github.com/BryantWelch/mcmodupdate.app/releases"
                target="_blank"
                rel="noopener noreferrer"
                >Releases</a
              >
            </li>
          </ul>
        </div>
        <div class="footer-column">
          <h4>Resources</h4>
          <ul>
            <li>
              <a
                href="https://modrinth.com"
                target="_blank"
                rel="noopener noreferrer"
                >Modrinth Official</a
              >
            </li>
            <li>
              <a
                href="https://www.curseforge.com/minecraft/mc-mods"
                target="_blank"
                rel="noopener noreferrer"
                >CurseForge Mods</a
              >
            </li>
            <li>
              <a
                href="https://fabricmc.net/"
                target="_blank"
                rel="noopener noreferrer"
                >FabricMC</a
              >
            </li>
            <li>
              <a
                href="https://neoforged.net/"
                target="_blank"
                rel="noopener noreferrer"
                >NeoForged</a
              >
            </li>
          </ul>
        </div>
        <div class="footer-column">
          <h4>Community</h4>
          <ul>
            <li>
              <a
                href="https://www.reddit.com/r/ModdedMinecraft/"
                target="_blank"
                rel="noopener noreferrer"
                >r/ModdedMinecraft</a
              >
            </li>
            <li>
              <a
                href="https://www.reddit.com/r/feedthebeast/"
                target="_blank"
                rel="noopener noreferrer"
                >r/feedthebeast</a
              >
            </li>
            <li>
                <a
                href="https://discord.gg/moddedmc"
                target="_blank"
                rel="noopener noreferrer"
                >Modded Minecraft Discord</a
              >
            </li>
            <li>
              <a
                href="https://discord.fabricmc.net/"
                target="_blank"
                rel="noopener noreferrer"
                >Fabric Project Discord</a
              >
            </li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>
          &copy; <span id="current-year">2024</span> Bryant Welch. Open source under 
          <a href="https://github.com/BryantWelch/mcmodupdate.app/blob/main/LICENSE" target="_blank" rel="noopener noreferrer">MIT License</a>.
        </p>
        <a
          href="https://ko-fi.com/bryantwelch"
          target="_blank"
          rel="noopener noreferrer"
          class="kofi-button"
          title="Support the developer!"
        >
          <img
            src="https://storage.ko-fi.com/cdn/kofi5.png?v=6"
            alt="Buy Me a Coffee at ko-fi.com"
          />
        </a>
      </div>
    </footer>

    <!-- SCROLL BUTTONS -->
    <div id="scroll-buttons-container">
      <button id="scroll-to-top-btn" class="scroll-btn" title="Scroll to top"> <!-- "Scroll to Top" button is first -->
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="17 11 12 6 7 11"></polyline>
          <polyline points="17 18 12 13 7 18"></polyline>
        </svg>
      </button>
      <button id="scroll-to-bottom-btn" class="scroll-btn" title="Scroll to bottom"> <!-- "Scroll to Bottom" button is second -->
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="7 13 12 18 17 13"></polyline>
          <polyline points="7 6 12 11 17 6"></polyline>
        </svg>
      </button>
    </div>

    <script>
      // --- Global State ---
      let uploadedFiles = new Map();
      let successfulDownloads = [];
      let sectionCounts = {};
      let renderedModIds = new Set();
      let searchedMods = new Map();
      let isCurrentlySearching = false;
      let welcomeMessageSnapshot = null; // Store the welcome message snapshot
      let apiCallCount = 0; // Track total API calls made
      let processingStartTime = 0; // Track when processing started
      let dependencyMap = new Map(); // Track which mod requires each dependency

      // --- DOM Element References ---
      const dropzone = document.getElementById("dropzone");
      const dropzonePrompt = document.getElementById("dropzone-prompt");
      const fileListContainer = document.getElementById("file-list-container");
      const fileInput = document.getElementById("file-input");
      const infoButton = document.getElementById("info-button");
      const infoModal = document.getElementById("info-modal");
      const modalCloseButton = document.getElementById("modal-close-button");
      const mcVersionSelect = document.getElementById("mc-version");
      const updateButton = document.getElementById("update-button");
      const updateButtonIcon = updateButton.querySelector("svg");
      const modLoaderSelect = document.getElementById("mod-loader");
      const resultsArea = document.getElementById("results-area");
      const progressBarContainer = document.getElementById("progress-bar-container");
      const progressBar = document.getElementById("progress-bar");
      const statusMessage = document.getElementById("status-message");
      const clearAllButton = document.getElementById("clear-all-button");
      const alertModal = document.getElementById("alert-modal");
      const alertMessage = document.getElementById("alert-message");
      const alertOkButton = document.getElementById("alert-ok-button");
      const alertIcon = document.getElementById("alert-icon");
      const alertTitle = document.getElementById("alert-title");
      const scrollToTopBtn = document.getElementById("scroll-to-top-btn");
      const scrollToBottomBtn = document.getElementById("scroll-to-bottom-btn");
      const searchInput = document.getElementById("mod-search");
      const searchModal = document.getElementById("search-modal");
      const searchResultsContainer = document.getElementById("search-results-container");
      const searchCloseButton = document.getElementById("search-close-button");
      const searchXCloseButton = document.getElementById("search-x-close-button");
      const searchClearButton = document.getElementById("search-clear-button");
      const clearResultsButton = document.getElementById("clear-results-button");

      // --- UI LOGIC ---
      infoButton.addEventListener("click", () => {
        infoModal.classList.add("visible");
      });
      modalCloseButton.addEventListener("click", () => {
        infoModal.classList.remove("visible");
      });
      infoModal.addEventListener("click", (event) => {
        if (event.target === infoModal) {
          infoModal.classList.remove("visible");
        }
      });

      // --- Clear Results Button Logic ---
      clearResultsButton.addEventListener("click", resetResults);

      // --- Custom Alert Modal Logic ---
      function showCustomAlert(message, type = "notice") {
        const icons = {
          notice: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--warning-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,
          error: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--error-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`,
        };
        const titles = {
          notice: "Notice",
          error: "Error",
        };

        // Set the text content of the title, excluding the icon
        alertTitle.childNodes[1].nodeValue = titles[type] || "Notice";
        alertIcon.innerHTML = icons[type] || icons.notice;
        
        alertMessage.textContent = message;
        alertModal.classList.add("visible");
      }

      function hideCustomAlert() {
        alertModal.classList.remove("visible");
      }

      alertOkButton.addEventListener("click", hideCustomAlert);
      alertModal.addEventListener("click", (event) => {
        if (event.target === alertModal) {
          hideCustomAlert();
        }
      });

      // --- Scroll to Top/Bottom Button Logic ---
      function handleScrollButtons() {
        const scrollY = window.scrollY;
        const pageHeight = document.documentElement.scrollHeight;
        const viewportHeight = document.documentElement.clientHeight;

        // First, check if the page is scrollable at all. If not, hide both and exit.
        if (pageHeight <= viewportHeight) {
          scrollToTopBtn.style.display = "none";
          scrollToBottomBtn.style.display = "none";
          return;
        }

        // --- "Scroll to Top" Button Logic ---
        // Show if we are NOT at the top.
        if (scrollY > 0) {
          scrollToTopBtn.style.display = "flex";
        } else {
          scrollToTopBtn.style.display = "none";
        }

        // --- "Scroll to Bottom" Button Logic ---
        // Show if we are NOT at the bottom.
        // The '- 1' is a small buffer for rounding issues.
        if (scrollY + viewportHeight < pageHeight - 1) {
          scrollToBottomBtn.style.display = "flex";
        } else {
          scrollToBottomBtn.style.display = "none";
        }
      }

      // Add click listeners for smooth scrolling
      scrollToTopBtn.addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      scrollToBottomBtn.addEventListener("click", () => {
        window.scrollTo({
          top: document.documentElement.scrollHeight,
          behavior: "smooth",
        });
      });

      // Listen for scroll events to show/hide the buttons
      window.addEventListener("scroll", handleScrollButtons);

      // --- Clear All Button Logic ---
      function clearDropzone() {
        // Clear the underlying file data
        uploadedFiles.clear();

        searchedMods.clear();

        // Clear the visual file pills from the UI
        fileListContainer.innerHTML = "";

        // Only hide the status message if we are NOT currently searching.
        if (!isCurrentlySearching) {
          statusMessage.classList.remove("visible");
        }

        // Reset the dropzone to its initial, non-expanded state
        dropzonePrompt.style.display = "block";
        dropzone.classList.remove("dropzone-expanded");

        // Hide the "Clear All" button since there's nothing to clear
        clearAllButton.style.display = "none";
      }

      // --- Mod Search Functionality ---
      function debounce(func, delay) {
        let timeout;
        return function(...args) {
          const context = this;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), delay);
        };
      }

      async function performSearch(query) {
        if (!query) {
          searchResultsContainer.innerHTML = "<p>Start typing to find mods.</p>";
          return;
        }
        searchResultsContainer.innerHTML = "<p>Searching...</p>";

        const searchUrl = `https://api.modrinth.com/v2/search?query=${encodeURIComponent(query)}&limit=10`;
        try {
          const response = await fetchWithRetry(searchUrl);
          const data = await response.json();
          renderSearchResults(data.hits);
        } catch (error) {
          searchResultsContainer.innerHTML = "<p>Error fetching search results.</p>";
          console.error("Search failed:", error);
        }
      }

      const debouncedSearch = debounce(performSearch, 500);

      searchInput.addEventListener("input", (e) => {
        const query = e.target.value.trim();
        
        // Show or hide the clear button
        if (query.length > 0) {
          searchClearButton.style.display = "block";
        } else {
          searchClearButton.style.display = "none";
        }

        // Perform search
        if (query.length > 1) {
          searchModal.classList.add("visible");
          debouncedSearch(query);
        } else {
          searchResultsContainer.innerHTML = "<p>Start typing to find mods.</p>";
        }
      });
      // Add click listener for the new clear button
      searchClearButton.addEventListener("click", () => {
        // Clear the input field
        searchInput.value = "";
        // Hide the clear button itself
        searchClearButton.style.display = "none";
        // Reset the search results in the modal
        searchResultsContainer.innerHTML = "<p>Start typing to find mods.</p>";
        // Give focus back to the input field so the user can type a new query
        searchInput.focus();
      });
      
      searchInput.addEventListener("focus", () => {
        if(searchInput.value.trim().length > 1) {
            searchModal.classList.add("visible");
        }
      });

      // --- Search Modal Close Logic ---
      searchCloseButton.addEventListener("click", () => {
        searchModal.classList.remove("visible");
      });

      searchXCloseButton.addEventListener("click", () => {
        searchModal.classList.remove("visible");
      });

      searchModal.addEventListener("click", (event) => {
        // If the user clicks on the dark overlay itself, not the content
        if (event.target === searchModal) {
          searchModal.classList.remove("visible");
        }
      });

      // --- Search Modal Results Logic ---
      function renderSearchResults(hits) {
        searchResultsContainer.innerHTML = "";
        if (hits.length === 0) {
          searchResultsContainer.innerHTML = "<p>No mods found.</p>";
          return;
        }
        hits.forEach(hit => {
          const card = createSearchResultCard(hit);
          searchResultsContainer.appendChild(card);
        });
      }

      // --- Search Modal Results Card Logic ---
      function createSearchResultCard(mod) {
        const card = document.createElement("div");
        card.className = "result-card";
        
        // The project URL is consistent for all links
        const projectUrl = `https://modrinth.com/project/${mod.slug}`;
        const authorUrl = `https://modrinth.com/user/${mod.author}`;

        card.innerHTML = `
          <div class="result-card-main">
            <a href="${projectUrl}" target="_blank" rel="noopener noreferrer" class="mod-icon-link">
              <img src="${mod.icon_url}" alt="${mod.title} icon" class="mod-icon" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgaWQ9Ik1pbmVjcmFmdCI+PHBhdGggZD0ibTIxIDFoLTE4YTIgMiAwIDAgMCAtMiAydjE4YTIgMiAwIDAgMCAyIDJoMThhMiAyIDAgMCAwIDItMnYtMThhMiAyIDAgMCAwIC0yLTJ6bS0xNSA4LjV2LTNhLjUuNSAwIDAgMSAuNS0uNWgzYS41LjUgMCAwIDEgLjUuNXYzYS41LjUgMCAwIDEgLS41LjVoLTNhLjUuNSAwIDAgMSAtLjUtLjV6bTExIDhhLjUuNSAwIDAgMSAtLjUuNWgtMmEuNS41IDAgMCAxIC0uNS0uNXYtMS41aC00djEuNWEuNS41IDAgMCAxIC0uNS41aC0yYS41LjUgMCAwIDEgLS41LS41di01YS41LjUgMCAwIDEgLjUtLjVoMi41di0xLjVhLjUuNSAwIDAgMSAuNS0uNWgzYS41LjUgMCAwIDEgLjUuNXYxLjVoMi41YS41LjUgMCAwIDEgLjUuNXptMS04YS41LjUgMCAwIDEgLS41LjVoLTNhLjUuNSAwIDAgMSAtLjUtLjV2LTNhLjUuNSAwIDAgMSAuNS0uNWgzYS41LjUgMCAwIDEgLjUuNXoiIGZpbGw9IiMzMDNjNDIiLz48L2c+PC9zdmc+'">
            </a>
            <div class="mod-details">
              <div class="mod-title">
                <a href="${projectUrl}" target="_blank" rel="noopener noreferrer">${mod.title}</a>
                <span class="mod-author">by <a href="${authorUrl}" target="_blank" rel="noopener noreferrer">${mod.author}</a></span>
              </div>
              <div class="mod-description">${mod.description}</div>
            </div>
            <div class="mod-actions">
              <button class="add-mod-button" data-slug="${mod.slug}" data-title="${mod.title}">Add</button>
            </div>
          </div>`;

        const addButton = card.querySelector(".add-mod-button");
        // Disable button if already added
        if (searchedMods.has(mod.slug) || renderedModIds.has(mod.slug)) {
            addButton.disabled = true;
            addButton.textContent = "Added";
        }

        addButton.addEventListener("click", (e) => {
          const slug = e.target.dataset.slug;
          const title = e.target.dataset.title;

          if (!searchedMods.has(slug)) {
            searchedMods.set(slug, { title: title });
            createFilePill({ name: `${title} (Searched)` });
            dropzonePrompt.style.display = "none";
            dropzone.classList.add("dropzone-expanded");
            clearAllButton.style.display = "inline-flex";
          }
          
          e.target.disabled = true;
          e.target.textContent = "Added";
          searchModal.classList.remove("visible");
        });

        return card;
      }

      clearAllButton.addEventListener("click", clearDropzone);

      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropzone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });
      ["dragenter", "dragover"].forEach((eventName) => {
        dropzone.addEventListener(eventName, () => {
          dropzone.classList.add("dragover");
        });
      });
      ["dragleave", "drop"].forEach((eventName) => {
        dropzone.addEventListener(eventName, () => {
          dropzone.classList.remove("dragover");
        });
      });
      dropzone.addEventListener("drop", (event) => {
        handleFiles(event.dataTransfer.files);
      });
      dropzone.addEventListener("click", (event) => {
        if (
          !event.target.classList.contains("file-pill-remove") &&
          !event.target.closest(".file-pill-remove")
        ) {
          fileInput.click();
        }
      });
      fileInput.addEventListener("change", (event) => {
        if (event.target.files.length > 0) {
          handleFiles(event.target.files);
        }
        event.target.value = null;
      });

      function handleFiles(files) {
        if (files.length === 0) return;

        // Check if a .mrpack file is among the dropped files
        const mrpackFile = Array.from(files).find((file) =>
          file.name.endsWith(".mrpack")
        );

        if (mrpackFile) {
          // If a modpack is found, clear everything and process only the pack.
          clearDropzone();
          processMrpack(mrpackFile);
        } else {
          // Otherwise, proceed with the normal JAR file handling.
          dropzonePrompt.style.display = "none";
          dropzone.classList.add("dropzone-expanded");
          clearAllButton.style.display = "inline-flex";
          for (const file of files) {
            if (file.name.endsWith(".jar") && !uploadedFiles.has(file.name)) {
              uploadedFiles.set(file.name, file);
              createFilePill(file);
            }
          }
        }
      }

      // --- Process .mrpack file ---
      async function processMrpack(packFile) {
        try {
          // Update UI to show processing has started
          dropzonePrompt.style.display = "none";
          dropzone.classList.add("dropzone-expanded");
          clearAllButton.style.display = "inline-flex";
          createFilePill({ name: `Processing: ${packFile.name}...` }); // Temporary pill

          const zip = await JSZip.loadAsync(packFile);
          const manifestFile = zip.file("modrinth.index.json");

          if (!manifestFile) {
            showCustomAlert(
              "The uploaded file is not a valid Modrinth modpack (missing modrinth.index.json).",
              "error"
            );
            clearDropzone(); // Clear the "Processing..." pill
            return;
          }

          const content = await manifestFile.async("string");
          const manifest = JSON.parse(content);

          // Clear the temporary "Processing..." pill
          fileListContainer.innerHTML = "";

          // --- Informational Message: Get Source Version and Loader ---
          let sourceVersion = "unknown";
          let sourceLoader = "unknown";

          if (manifest.dependencies) {
            if (manifest.dependencies.minecraft) {
              sourceVersion = manifest.dependencies.minecraft;
            }
            if (manifest.dependencies["fabric-loader"]) {
              sourceLoader = "Fabric";
            } else if (manifest.dependencies.forge) {
              sourceLoader = "Forge";
            } else if (manifest.dependencies["quilt-loader"]) {
              sourceLoader = "Quilt";
            } else if (manifest.dependencies.neoforge) {
              sourceLoader = "NeoForge";
            }
          }

          statusMessage.textContent = `Detected: ${sourceLoader} pack for MC ${sourceVersion}. Ready to find updates for your selected version.`;
          statusMessage.classList.add("visible");
          // --- END of Informational Message: Get Source Version and Loader ---

          // The manifest.files array contains the list of mods
          if (manifest.files && manifest.files.length > 0) {
            for (const modFile of manifest.files) {
              // The path often looks like "mods/fabric-api-0.91.0.jar"
              const filename = modFile.path.split("/").pop();
              const sha1Hash = modFile.hashes.sha1;

              if (sha1Hash && filename) {
                // Use the hash as the unique key and store the filename for display.
                // This reuses your existing `searchedMods` map perfectly.
                searchedMods.set(sha1Hash, { title: filename });
                createFilePill({ name: filename });
              }
            }
          }
        } catch (error) {
          console.error("Error processing .mrpack file:", error);
          showCustomAlert(
            "Could not read the uploaded .mrpack file. It may be corrupt.",
            "error"
          );
          clearDropzone();
        }
      }


      // --- File Pill Logic ---
      function createFilePill(file) {
        const filePill = document.createElement("div");
        filePill.classList.add("file-pill");
        const fileNameSpan = document.createElement("span");
        fileNameSpan.textContent = file.name;
        filePill.appendChild(fileNameSpan);
        const removeButton = document.createElement("span");
        removeButton.classList.add("file-pill-remove");
        removeButton.innerHTML = "&times;";
        removeButton.setAttribute("role", "button");
        removeButton.setAttribute("tabindex", "0");
        removeButton.setAttribute("aria-label", "Remove " + file.name);
        removeButton.onclick = function (event) {
          event.stopPropagation();
          uploadedFiles.delete(file.name);
          filePill.remove();
          if (uploadedFiles.size === 0) {
            dropzonePrompt.style.display = "block";
            dropzone.classList.remove("dropzone-expanded");
            clearAllButton.style.display = "none"; // HIDE THE BUTTON
          }
        };
        removeButton.onkeydown = function (event) {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            removeButton.onclick(event);
          }
        };
        filePill.appendChild(removeButton);
        fileListContainer.appendChild(filePill);
      }

      document.getElementById("current-year").textContent =
        new Date().getFullYear();

// --- Dynamic Minecraft Version Loading with Hierarchical Layout ---
async function populateMcVersions() {
  try {
    const response = await fetch(
      "https://api.modrinth.com/v2/tag/game_version"
    );
    if (!response.ok) throw new Error("Failed to fetch MC versions");
    const versions = await response.json();

    // Filter for release versions and sort them numerically descending
    const releaseVersions = versions
      .filter(
        (v) =>
          v.version_type === "release" &&
          /^\d+\.\d+(\.\d+)?$/.test(v.version)
      )
      .sort((a, b) => {
        const aParts = a.version.split(".").map(Number);
        const bParts = b.version.split(".").map(Number);
        for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
          const aVal = aParts[i] || 0;
          const bVal = bParts[i] || 0;
          if (aVal !== bVal) return bVal - aVal; // Sort descending
        }
        return 0;
      });

    const groupedVersions = {};

    // Group versions by their major release (e.g., "1.21.6" -> "1.21")
    releaseVersions.forEach((versionObj) => {
      // Access the .version property of the object
      const versionStr = versionObj.version;
      const parts = versionStr.split(".");

      if (parts.length >= 2) {
        const majorVersion = `${parts[0]}.${parts[1]}`;
        if (!groupedVersions[majorVersion]) {
          groupedVersions[majorVersion] = [];
        }
        // Only add patch versions (like 1.21.6) to the sub-list
        if (parts.length > 2) {
          // Push the version string, not the whole object
          groupedVersions[majorVersion].push(versionStr);
        }
      }
    });

    // Get the major versions and sort them again to ensure order
    const sortedMajorVersions = Object.keys(groupedVersions).sort((a, b) => {
      const aParts = a.split(".").map(Number);
      const bParts = b.split(".").map(Number);
      for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
        const aVal = aParts[i] || 0;
        const bVal = bParts[i] || 0;
        if (aVal !== bVal) return bVal - aVal;
      }
      return 0;
    });

    mcVersionSelect.innerHTML = ""; // Clear existing options

    // Populate the dropdown with the hierarchical structure
    sortedMajorVersions.forEach((majorVersion) => {
      // Add the main version entry (e.g., 1.21)
      const mainOption = document.createElement("option");
      mainOption.value = majorVersion;
      mainOption.textContent = majorVersion;
      mcVersionSelect.appendChild(mainOption);

      // Add the indented sub-version entries (e.g., 1.21.6, 1.21.5)
      const subVersions = groupedVersions[majorVersion];
      subVersions.forEach((subVersion) => {
        const subOption = document.createElement("option");
        subOption.value = subVersion;
        // Use non-breaking spaces for indentation
        subOption.innerHTML = `&nbsp;&nbsp;${subVersion}`;
        mcVersionSelect.appendChild(subOption);
      });
    });

    // Select the latest version by default
    if (mcVersionSelect.options.length > 0) {
      mcVersionSelect.options[0].selected = true;
    }
  } catch (error) {
    console.error("A real error occurred:", error); // Changed for better debugging
    // Fallback or show an error
    mcVersionSelect.innerHTML =
      '<option value="1.21">Error loading versions</option>';
    showCustomAlert(
      "Could not load Minecraft versions from Modrinth. Please check your connection and refresh.",
      "error"
    );
  }
}

// Call these functions when the page loads
document.addEventListener("DOMContentLoaded", () => {
  populateMcVersions();
  handleScrollButtons(); // This runs our check once on load
  
  // Capture the welcome message snapshot
  welcomeMessageSnapshot = resultsArea.innerHTML;
});

// --- UI State Reset Function ---
function resetResults() {
  // Restore the welcome message from snapshot
  if (welcomeMessageSnapshot) {
    resultsArea.innerHTML = welcomeMessageSnapshot;
  } else {
    // Fallback if snapshot isn't available
    resultsArea.innerHTML = "";
  }

  // Hide the progress bar and status message
  progressBarContainer.style.display = "none";
  progressBar.style.width = "0%";
  statusMessage.classList.remove("visible");

  // Reset the data arrays
  successfulDownloads = [];
  sectionCounts = { found: 0, warning: 0, failure: 0 };

  // Hide the "Clear Results" button
  clearResultsButton.style.display = "none";

  // Re-enable the update button
  updateButton.disabled = false;
  updateButton.innerHTML = `Update
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="20"
      height="20"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
      <polyline points="17 8 12 3 7 8"></polyline>
      <line x1="12" y1="3" x2="12" y2="15"></line>
    </svg>`;
}

// --- Main Update Logic with Live Rendering and Dependency Resolution ---
updateButton.addEventListener("click", handleUpdate);

async function handleUpdate() {
  // Combine jobs from both sources first.
  const fileJobs = Array.from(uploadedFiles.values()).map((file) => ({
    type: "file",
    data: file,
  }));
  const searchJobs = Array.from(searchedMods.entries()).map(
    ([key, modInfo]) => {
      const isHash = /^[a-f0-9]{40}$/.test(key);
      return {
        type: isHash ? "hash" : "id",
        data: key,
        title: modInfo.title,
      };
    }
  );
  const jobs = [...fileJobs, ...searchJobs];

  // Check if there's anything to do.
  if (jobs.length === 0) {
    showCustomAlert("Please upload or search for mods first.", "notice");
    return;
  }

  // --- START of new logic ---
  isCurrentlySearching = true;
  try {
    // --- END of new logic ---

    // Reset the UI and state for a new run.
    resetResults();
    renderedModIds.clear();
    dependencyMap.clear(); // Reset dependency tracking
    apiCallCount = 0; // Reset API call counter
    processingStartTime = Date.now(); // Start timing
    updateButton.disabled = true;
    updateButton.innerHTML = "Searching...";
    statusMessage.textContent = "Searching for updates and dependencies...";
    statusMessage.classList.add("visible");
    setupResultSections();
    progressBarContainer.style.display = "block";

    const processedIds = new Set();
    let allJobs = [...jobs];
    let completedJobs = 0;
    const allDependencies = new Set(); // Store all discovered dependencies

    // Phase 1: Process all initial mods in batches
    statusMessage.textContent = `Searching updates for ${jobs.length} mods...`;
    while (allJobs.length > 0) {
      const batchSize = 25;
      const currentBatch = allJobs.splice(0, batchSize);
      
      const results = await getModUpdateInfoBatch(currentBatch, batchSize);
      
      // Process and render results immediately as each batch completes
      for (const result of results) {
        const key = result.modId || (result.title + result.reason);
        
        if (processedIds.has(key)) {
          completedJobs++;
          continue;
        }
        processedIds.add(key);

        if (result.status === "success" && renderedModIds.has(result.modId)) {
          console.log(`Skipping duplicate render for: ${result.title}`);
        } else {
          renderSingleResult(result);
          if (result.status === "success") {
            renderedModIds.add(result.modId);
          }
        }

        // Collect dependencies but don't process them yet
        if (result.status === "success" && result.dependencies) {
          for (const dep of result.dependencies) {
            if (dep.dependency_type === "required") {
              allDependencies.add(dep.project_id);
              // Track which mod requires this dependency
              dependencyMap.set(dep.project_id, result.title);
            }
          }
        }
        
        completedJobs++;
      }
      
      // Update progress bar after each batch (50% for initial mods)
      const progressPercentage = Math.min((completedJobs / jobs.length) * 50, 50);
      progressBar.style.width = `${progressPercentage}%`;
      
      // Add a small delay to let the UI update and show the new results
      if (allJobs.length > 0) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
    }

        // Phase 2: Process dependencies
    // Filter out dependencies that are already processed
    const unprocessedDependencies = Array.from(allDependencies).filter(depId => !processedIds.has(depId));
    let actualDependenciesAdded = 0; // Track dependencies that are actually added
    
    if (unprocessedDependencies.length > 0) {
      statusMessage.textContent = `Searching dependencies for ${jobs.length} mods...`;
      
      // Create dependency jobs
      const dependencyJobs = unprocessedDependencies.map(depId => ({
        type: "id",
        data: depId,
        title: `Dependency: ${depId}`
      }));
      
      let depCompletedJobs = 0;
      
      // Process dependencies in batches of 25
      while (dependencyJobs.length > 0) {
        const batchSize = 25;
        const currentBatch = dependencyJobs.splice(0, batchSize);
        
        const results = await getModUpdateInfoBatch(currentBatch, batchSize);
        
        // Process and render dependency results
        for (const result of results) {
          const key = result.modId || (result.title + result.reason);
          
          if (processedIds.has(key)) {
            depCompletedJobs++;
            continue;
          }
          processedIds.add(key);

          if (result.status === "success" && renderedModIds.has(result.modId)) {
            console.log(`Skipping duplicate render for dependency: ${result.title}`);
          } else {
            renderSingleResult(result);
            if (result.status === "success") {
              renderedModIds.add(result.modId);
              actualDependenciesAdded++; // Only count successfully added dependencies
            }
          }
          
          depCompletedJobs++;
        }
        
        // Update progress bar for dependency processing (50% + remaining 50%)
        const depProgressPercentage = 50 + ((depCompletedJobs / unprocessedDependencies.length) * 50);
        progressBar.style.width = `${Math.min(depProgressPercentage, 95)}%`;
        
        // Add a small delay to let the UI update
        if (dependencyJobs.length > 0) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
      }
    }

    // Complete the progress bar and create summary
    progressBar.style.width = "100%";
    
    finalizeResultsUI();
    
    // Create comprehensive summary
    const updatesFound = sectionCounts.found || 0;
    const notCompatible = sectionCounts.warning || 0;
    const notFound = sectionCounts.failure || 0;
    const dependenciesAdded = actualDependenciesAdded || 0;
    
    // Calculate processing time
    const processingTime = ((Date.now() - processingStartTime) / 1000).toFixed(1);
    
    let summaryText = `Updates found: ${updatesFound}`;
    if (notCompatible > 0) summaryText += `, Not compatible: ${notCompatible}`;
    if (notFound > 0) summaryText += `, Failed to find: ${notFound}`;
    if (dependenciesAdded > 0) summaryText += `, Dependencies added: ${dependenciesAdded}`;
    
    // Add processing time and API calls on one line below the summary
    summaryText += `<br>Processing time: ${processingTime}s, API calls used: ${apiCallCount}`;
    
    // Store the summary for the finally block
    window.finalSummaryText = summaryText;
    statusMessage.innerHTML = summaryText;
    // Keep the status message visible instead of hiding it

    setTimeout(() => {
      progressBarContainer.style.display = "none";
    }, 1000);

    
  } catch (error) {
    console.error("Error in handleUpdate:", error);
    statusMessage.textContent = `Error processing mods: ${error.message}`;
    statusMessage.classList.add("visible");
    
    // Reset UI state on error
    progressBarContainer.style.display = "none";
  } finally {
    isCurrentlySearching = false;
    // Always reset the button state
    updateButton.disabled = false;
    updateButton.innerHTML = `Update
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>`;
    
    // Ensure we show the final summary if it was calculated
    if (window.finalSummaryText && sectionCounts.found > 0) {
      statusMessage.innerHTML = window.finalSummaryText;
      statusMessage.classList.add("visible");
      window.finalSummaryText = null; // Clean up
    } else if (apiCallCount > 0) {
      // If we have API calls but no final summary, at least show the API count
      const fallbackTime = ((Date.now() - processingStartTime) / 1000).toFixed(1);
      statusMessage.innerHTML = `Processing completed<br>Processing time: ${fallbackTime}s, API calls used: ${apiCallCount}`;
      statusMessage.classList.add("visible");
    }
  }
}

// --- API Fetcher with Transparent Rate Limit and Custom User-Agent ---
async function fetchWithRetry(url, options, retries = 3) {
  const requestOptions = {
    ...options, // Spread any existing options
          headers: {
        // Add our custom User-Agent following Modrinth's recommendations
        // "User-Agent": "BryantWelch/mcmodupdate.app/1.0.0 (https://github.com/BryantWelch/mcmodupdate.app)",
        ...(options?.headers || {})
      },
  };

  for (let i = 0; i < retries; i++) {
    // Use the new requestOptions object
    const response = await fetch(url, requestOptions);
    
    // Count successful API calls (including retries)
    if (response.ok) {
      apiCallCount++;
    }

    if (response.status === 429) {
      const resetTimestamp = Number(
        response.headers.get("X-Ratelimit-Reset")
      );
      const currentTime = Math.floor(Date.now() / 1000);
      const waitTime = resetTimestamp
        ? Math.max(0, resetTimestamp - currentTime) + 1
        : 10; // Default to 10 seconds if reset time is not available

      const originalMessage = statusMessage.textContent;
      console.warn(
        `Rate limited. Waiting for ${waitTime} seconds until the limit resets.`
      );
      
      // Show countdown for rate limiting
      for (let i = waitTime; i > 0; i--) {
        statusMessage.textContent = `Rate limited. Pausing for ${i} seconds...`;
        await new Promise((resolve) => setTimeout(resolve, 1000));
      }

      statusMessage.textContent = originalMessage;
      continue;
    }
    return response;
  }
  throw new Error(
    "Failed to fetch after multiple retries due to rate limiting."
  );
}

// --- Main Batch Processing Function ---
async function getModUpdateInfoBatch(jobs, batchSize = 25) {
  // Process the entire job list as a single batch since we're already batching at the higher level
  return await processBatch(jobs);
}

async function processBatch(jobs) {
  const loader = modLoaderSelect.value;
  const gameVersion = mcVersionSelect.value;
  
  // Step 1: Collect all hashes and project IDs
  const hashJobs = [];
  const projectIdJobs = [];
  const fileJobs = [];
  
  for (const job of jobs) {
    if (job.type === "file") {
      const hash = await calculateFileHash(job.data);
      if (hash) {
        hashJobs.push({ job, hash });
      } else {
        fileJobs.push(job);
      }
    } else if (job.type === "hash") {
      hashJobs.push({ job, hash: job.data });
    } else if (job.type === "id") {
      projectIdJobs.push(job);
    }
  }
  
  // Step 2: Batch hash lookups
  const hashResults = await batchHashLookup(hashJobs);
  
  // Step 3: Batch project lookups
  const allProjectIds = [
    ...hashResults.map(r => r.versionData?.project_id).filter(Boolean),
    ...projectIdJobs.map(j => j.data)
  ];
  
  const projectsData = await batchProjectLookup(allProjectIds);
  
  // Step 4: Batch author lookups
  const authorData = await batchAuthorLookup(projectsData);
  
  // Step 5: Batch version lookups for compatible versions
  const versionData = await batchVersionLookup(allProjectIds, loader, gameVersion);
  
  // Step 6: Combine results
  return await combineResults(jobs, hashResults, projectsData, authorData, versionData);
}

// --- Batch Hash Lookup Function ---
async function batchHashLookup(hashJobs) {
  if (hashJobs.length === 0) return [];
  
  // Use the batch version_files endpoint
  const hashes = hashJobs.map(hj => hj.hash);
  
  const response = await fetchWithRetry('https://api.modrinth.com/v2/version_files', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      algorithm: "sha1",
      hashes: hashes
    })
  });
  
  if (response.ok) {
    const versionMap = await response.json();
    return hashJobs.map(hj => ({
      job: hj.job,
      hash: hj.hash,
      versionData: versionMap[hj.hash] || null
    }));
  }
  
  return hashJobs.map(hj => ({ job: hj.job, hash: hj.hash, versionData: null }));
}

// --- Batch Project Lookup Function ---
async function batchProjectLookup(projectIds) {
  if (projectIds.length === 0) return {};
  
  // Remove duplicates
  const uniqueIds = [...new Set(projectIds.filter(Boolean))];
  
  // Use batch projects endpoint
  const idsParam = JSON.stringify(uniqueIds);
  const response = await fetchWithRetry(
    `https://api.modrinth.com/v2/projects?ids=${encodeURIComponent(idsParam)}`
  );
  
  if (response.ok) {
    const projects = await response.json();
    // Convert array to map for easy lookup
    return projects.reduce((acc, project) => {
      acc[project.id] = project;
      return acc;
    }, {});
  }
  
  return {};
}

// --- Batch Author Lookup Function ---
async function batchAuthorLookup(projectsData) {
  const projects = Object.values(projectsData);
  
  // Collect team IDs and organization IDs
  const teamIds = projects.map(p => p.team).filter(Boolean);
  const orgIds = projects.map(p => p.organization).filter(Boolean);
  
  // Batch fetch teams and organizations in parallel
  const [teamsData, orgsData] = await Promise.all([
    batchTeamLookup(teamIds),
    batchOrganizationLookup(orgIds)
  ]);
  
  return { teams: teamsData, organizations: orgsData };
}

async function batchTeamLookup(teamIds) {
  if (teamIds.length === 0) return {};
  
  const uniqueIds = [...new Set(teamIds)];
  const idsParam = JSON.stringify(uniqueIds);
  
  const response = await fetchWithRetry(
    `https://api.modrinth.com/v3/teams?ids=${encodeURIComponent(idsParam)}`
  );
  
  if (response.ok) {
    const teams = await response.json();
    return teams.reduce((acc, team) => {
      acc[team[0]?.team_id] = team;
      return acc;
    }, {});
  }
  
  return {};
}

async function batchOrganizationLookup(orgIds) {
  if (orgIds.length === 0) return {};
  
  const uniqueIds = [...new Set(orgIds)];
  const idsParam = JSON.stringify(uniqueIds);
  
  const response = await fetchWithRetry(
    `https://api.modrinth.com/v3/organizations?ids=${encodeURIComponent(idsParam)}`
  );
  
  if (response.ok) {
    const orgs = await response.json();
    return orgs.reduce((acc, org) => {
      acc[org.id] = org;
      return acc;
    }, {});
  }
  
  return {};
}

// --- Batch Version Lookup Function ---
async function batchVersionLookup(projectIds, loader, gameVersion) {
  if (projectIds.length === 0) return {};
  
  // For getting compatible versions, we can use the version_files/update endpoint
  // or make individual calls for each project's versions
  const versionPromises = projectIds.map(async (projectId) => {
    const versionUrl = `https://api.modrinth.com/v2/project/${projectId}/version?loaders=["${loader}"]&game_versions=["${gameVersion}"]`;
    const response = await fetchWithRetry(versionUrl);
    
    if (response.ok) {
      const versions = await response.json();
      return { projectId, versions };
    }
    
    return { projectId, versions: [] };
  });
  
  const results = await Promise.all(versionPromises);
  
  return results.reduce((acc, result) => {
    acc[result.projectId] = result.versions;
    return acc;
  }, {});
}

// --- Results Combination Function ---
async function combineResults(jobs, hashResults, projectsData, authorData, versionData) {
  const results = [];
  
  for (const job of jobs) {
    try {
      let projectDetails = null;
      let versionDetails = null;
      let originalModInfo = {};
      
      // Find project details based on job type
      if (job.type === "hash" || job.type === "file") {
        const hashResult = hashResults.find(hr => hr.job === job);
        if (hashResult?.versionData) {
          projectDetails = projectsData[hashResult.versionData.project_id];
          versionDetails = hashResult.versionData;
        }
        
                 // Get original version from uploaded file if available
         if (job.type === "file") {
           try {
             originalModInfo = await getModIdFromJar(job.data);
           } catch (e) {
             // Ignore errors getting mod info from JAR
             originalModInfo = {};
           }
         }
      } else if (job.type === "id") {
        projectDetails = projectsData[job.data];
      }
      
             if (!projectDetails) {
         results.push({
           status: "failure",
           title: job.type === "file" ? job.data.name : job.title,
           reason: "Mod not found on Modrinth"
         });
         continue;
       }
      
      // Get author details
      const author = getAuthorFromBatchData(projectDetails, authorData);
      
      // Get compatible versions
      const versions = versionData[projectDetails.id] || [];
      const release = versions.find(v => v.version_type === "release");
      const beta = versions.find(v => v.version_type === "beta");
      const alpha = versions.find(v => v.version_type === "alpha");
      const latestVersion = release || beta || alpha;
      
             if (!latestVersion) {
         results.push({
           status: "warning",
           title: projectDetails.title,
           author_name: author.name,
           author_url: author.url,
           description: projectDetails.description,
           icon_url: projectDetails.icon_url,
           project_url: `https://modrinth.com/project/${projectDetails.slug}`,
           client_side: projectDetails.client_side,
           server_side: projectDetails.server_side,
           downloads: projectDetails.downloads,
           reason: "No compatible version found for selected loader/version."
         });
         continue;
       }
      
             const primaryFile = latestVersion.files.find(f => f.primary);
       if (!primaryFile) {
         results.push({
           status: "warning",
           title: projectDetails.title,
           author_name: author.name,
           author_url: author.url,
           reason: "No primary file found for latest version."
         });
         continue;
       }
      
      // Compare versions if we have original mod info
      const isUpToDate = originalModInfo.version && 
        latestVersion && 
        originalModInfo.version === latestVersion.version_number;
      
      // Gather download info for .mrpack file
      const downloadInfo = {
        url: primaryFile.url,
        filename: primaryFile.filename,
        hashes: primaryFile.hashes,
        path: `mods/${primaryFile.filename}`,
        fileSize: primaryFile.size,
        client_side: projectDetails.client_side,
        server_side: projectDetails.server_side,
      };
      
      // Add to successful downloads if not already tracked
      if (!renderedModIds.has(projectDetails.slug)) {
        successfulDownloads.push(downloadInfo);
      }
      
              // Build success response
        results.push({
          status: "success",
          modId: projectDetails.slug,
          projectId: projectDetails.id, // Add project ID for dependency tracking
          isUpToDate: isUpToDate,
          categories: projectDetails.categories,
          title: projectDetails.title,
        author_name: author.name,
        author_url: author.url,
        description: projectDetails.description,
        icon_url: projectDetails.icon_url,
        project_url: `https://modrinth.com/project/${projectDetails.slug}`,
        client_side: projectDetails.client_side,
        server_side: projectDetails.server_side,
        followers: projectDetails.followers,
        downloads: projectDetails.downloads,
        all_versions: versions,
        dependencies: latestVersion.dependencies,
        isDependency: job.type === "id"
      });
      
    } catch (error) {
      results.push({
        status: "failure",
        title: job.type === "file" ? job.data.name : job.title,
        reason: error.message
      });
    }
  }
  
  return results;
}

function getAuthorFromBatchData(projectDetails, authorData) {
  // Check for organization first
  if (projectDetails.organization) {
    const org = authorData.organizations[projectDetails.organization];
    if (org) {
      return {
        name: org.name,
        url: `https://modrinth.com/organization/${org.slug}`
      };
    }
  }
  
  // Fall back to team owner
  const team = authorData.teams[projectDetails.team];
  if (team) {
    const owner = team.find(member => member.is_owner || member.role === "Owner");
    if (owner?.user) {
      return {
        name: owner.user.username,
        url: `https://modrinth.com/user/${owner.user.username}`
      };
    }
  }
  
  return { name: "unknown", url: "#" };
}

      // --- Get Mod ID from JAR ---
      async function getModIdFromJar(jarFile) {
  try {
    const zip = await JSZip.loadAsync(jarFile);
    const fabricFile = zip.file("fabric.mod.json");
    if (fabricFile) {
      const content = await fabricFile.async("string");
      const manifest = JSON.parse(content);
      // Also return the version property
      return {
        id: manifest.id,
        name: manifest.name,
        version: manifest.version,
      };
    }

    const forgeFile = zip.file("META-INF/mods.toml");
    if (forgeFile) {
      const content = await forgeFile.async("string");
      const manifest = toml.parse(content);
      const modInfo = manifest.mods && manifest.mods[0];
      if (modInfo) {
        // Also return the version property
        return {
          id: modInfo.modId,
          name: modInfo.displayName,
          version: modInfo.version,
        };
      }
    }
    throw new Error("Could not find a valid manifest file.");
  } catch (e) {
    throw new Error("Invalid or corrupt JAR file.");
  }
}

      // --- Setup Result Sections ---
function setupResultSections() {
  // --- SVG icons for the layout toggle button ---
  const gridIcon = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>`;
  const listIcon = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>`;

  resultsArea.innerHTML = `
    <div id="results-found" class="results-section">
      <!-- Header container for title and button -->
      <div class="results-header-container">
        <h2 id="header-found">Updates Found</h2>
        <button id="layout-toggle-btn" class="layout-toggle" title="Toggle Layout">${gridIcon}</button>
      </div>
      <div class="results-list"></div>
    </div>
    <div id="results-warning" class="results-section">
      <h2 id="header-warning">No Compatible Version Found</h2>
      <div class="results-list"></div>
    </div>
    <div id="results-failure" class="results-section">
      <h2 id="header-failure">Could Not Find Mod</h2>
      <div class="results-list"></div>
    </div>
  `;

  // --- Logic for the layout toggle button ---
  const layoutToggleBtn = document.getElementById("layout-toggle-btn");
  const foundResultsList = document.querySelector("#results-found .results-list");

  // Function to set the layout based on stored preference or default
  function setLayout() {
    const currentLayout = localStorage.getItem("mod-layout") || "list";
    if (currentLayout === "grid") {
      foundResultsList.classList.add("grid-view");
      layoutToggleBtn.innerHTML = listIcon;
    } else {
      foundResultsList.classList.remove("grid-view");
      layoutToggleBtn.innerHTML = gridIcon;
    }
  }

  layoutToggleBtn.addEventListener("click", () => {
    foundResultsList.classList.toggle("grid-view");
    // Save the new preference to localStorage
    if (foundResultsList.classList.contains("grid-view")) {
      localStorage.setItem("mod-layout", "grid");
      layoutToggleBtn.innerHTML = listIcon; // Show list icon
    } else {
      localStorage.setItem("mod-layout", "list");
      layoutToggleBtn.innerHTML = gridIcon; // Show grid icon
    }
  });

  // Set the initial layout when the page loads
  setLayout();
}

      // --- Helper to update section headers with counts ---
      function updateSectionHeader(type, count) {
        const headerId = `header-${type}`; // e.g., 'header-found'
        const headerElement = document.getElementById(headerId);
        if (!headerElement) return; // Safety check

        let baseText = "";
        switch (type) {
          case "found":
            baseText = "Updates Found";
            break;
          case "warning":
            baseText = "No Compatible Version Found";
            break;
          case "failure":
            baseText = "Could Not Find Mod";
            break;
        }

        // Only show the count if it's greater than zero
        if (count > 0) {
          headerElement.textContent = `${baseText} (${count})`;
        }
      }

      function renderSingleResult(result) {
        let sectionId, card, countType;

        switch (result.status) {
          case "success":
            sectionId = "results-found";
            card = createSuccessCard(result);
            countType = "found";
            break;
          case "warning":
            sectionId = "results-warning";
            card = createWarningCard(result);
            countType = "warning";
            break;
          case "failure":
            sectionId = "results-failure";
            card = createFailureCard(result);
            countType = "failure";
            break;
        }

        // Increment the appropriate counter
        if (countType) {
          sectionCounts[countType]++;
          updateSectionHeader(countType, sectionCounts[countType]);
        }

        // First, check for duplicates.
        if (result.status === "success" && renderedModIds.has(result.modId)) {
          console.log(`Skipping duplicate render for: ${result.title}`);
          // If it's a duplicate, we do nothing else.
        } else {
          // If it's NOT a duplicate (or it's a warning/failure), then we render it.
          const section = document.getElementById(sectionId);
          if (section) {
            section.querySelector(".results-list").appendChild(card);
            section.classList.add("visible");
          }
          // And if it was a new success, we add it to our tracking set.
          if (result.status === "success") {
            renderedModIds.add(result.modId);
          }
        }
      }

      // --- Finalize Results UI ---
      function finalizeResultsUI() {
        // Check for the empty state first
        if (
          sectionCounts.found === 0 &&
          sectionCounts.warning === 0 &&
          sectionCounts.failure === 0
        ) {
    resultsArea.innerHTML = `
      <div class="results-section visible" style="text-align: center;">
        <h2>No Mods Found</h2>
        <p style="line-height: 1.6;">
          We couldn't find any mods matching your selected criteria. This can happen if the mods you uploaded don't have versions available for the selected Minecraft version and loader.
        </p>
      </div>
    `;
    return;
        }
        // Show the "Clear Results" button if there are any results
        clearResultsButton.style.display = "inline-flex";

        const foundSection = document.getElementById("results-found");
        if (foundSection && successfulDownloads.length > 0) {
          const actionsContainer = document.createElement("div");
          actionsContainer.className = "results-actions";

          // --- Create a dedicated container for the "Download All" button and its size ---
          const downloadAllGroup = document.createElement("div");
          downloadAllGroup.className = "download-button-group";

          // Create and add the "Download All" button to its group
          const downloadAllBtn = document.createElement("button");
          downloadAllBtn.className = "action-button";
          downloadAllBtn.innerHTML = `Download All (${successfulDownloads.length})
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>`;
          downloadAllBtn.onclick = () => {
            let i = 0;
            function downloadNext() {
              if (i < successfulDownloads.length) {
                const dl = successfulDownloads[i];
                const link = document.createElement("a");
                link.href = dl.url;
                link.setAttribute("download", dl.filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                i++;
                setTimeout(downloadNext, 300);
              }
            }
            downloadNext();
          };
          downloadAllGroup.appendChild(downloadAllBtn);

          // Create the .mrpack button (it will be a sibling to the group)
          const downloadPackBtn = document.createElement("button");
          downloadPackBtn.className = "action-button";
          downloadPackBtn.innerHTML = `Download as .mrpack`;
          downloadPackBtn.onclick = createModpack;

          // Add the group and the button to the main actions container
          actionsContainer.appendChild(downloadAllGroup);
          actionsContainer.appendChild(downloadPackBtn);
          foundSection.appendChild(actionsContainer);

          // --- Calculate and add the size info to the correct group ---
          try {
            const totalSizeBytes = successfulDownloads.reduce(
              (sum, file) => sum + (file.fileSize || 0),
              0
            );

            if (totalSizeBytes > 0) {
              const formattedSize = formatBytes(totalSizeBytes);
              const sizeInfo = document.createElement("p");
              sizeInfo.className = "download-size-info";
              sizeInfo.textContent = formattedSize; // Set text to ONLY the size
              downloadAllGroup.appendChild(sizeInfo); // Append to the button's group
            }
          } catch (error) {
            console.error("Could not calculate total download size:", error);
          }
        }

        // Hide empty sections
        if (sectionCounts.warning === 0) {
          const warningSection = document.getElementById("results-warning");
          if (warningSection) warningSection.style.display = "none";
        }
        if (sectionCounts.failure === 0) {
          const failureSection = document.getElementById("results-failure");
          if (failureSection) failureSection.style.display = "none";
        }
      }

      // Check if all sections are empty after processing
      if (
          sectionCounts.found === 0 &&
          sectionCounts.warning === 0 &&
          sectionCounts.failure === 0
        ) {
          resultsArea.innerHTML = `
            <div class="results-section visible">
              <h2>Search Complete</h2>
              <p>We couldn't find any information for the mods in your list on Modrinth. They may be from another source like CurseForge, or the files may be corrupt.</p>
            </div>
          `;
      }

      // --- Create Success Card ---
function createSuccessCard(mod) {
  const card = document.createElement("div");
  card.className = "result-card";

  const clientServerInfo = getClientServerSupport(
    mod.client_side,
    mod.server_side
  );
  const versionOptions = mod.all_versions
    .map((v) => {
      const type = v.version_type.charAt(0).toUpperCase();
      return `<option value="${v.id}">${v.version_number} [${type}]</option>`;
    })
    .join("");

  // This HTML now contains TWO sets of channel links.
  card.innerHTML = `
    <div class="result-card-main">
      <a href="${
        mod.project_url
      }" target="_blank" rel="noopener noreferrer" class="mod-icon-link">
        <img src="${
          mod.icon_url
        }" alt="${
    mod.title
  } icon" class="mod-icon" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgaWQ9Ik1pbmVjcmFmdCI+PHBhdGggZD0ibTIxIDFoLTE4YTIgMiAwIDAgMCAtMiAydjE4YTIgMiAwIDAgMCAyIDJoMThhMiAyIDAgMCAwIDItMnYtMThhMiAyIDAgMCAwIC0yLTJ6bS0xNSA4LjV2LTNhLjUuNSAwIDAgMSAuNS0uNWgzYS41LjUgMCAwIDEgLjUuNXYzYS41LjUgMCAwIDEgLS41LjVoLTNhLjUuNSAwIDAgMSAtLjUtLjV6bTExIDhhLjUuNSAwIDAgMSAtLjUuNWgtMmEuNS41IDAgMCAxIC0uNS0uNXYtMS41aC00djEuNWEuNS41IDAgMCAxIC0uNS41aC0yYS41LjUgMCAwIDEgLS41LS41di01YS41LjUgMCAwIDEgLjUtLjVoMi41di0xLjVhLjUuNSAwIDAgMSAuNS0uNWgzYS41LjUgMCAwIDEgLjUuNXYxLjVoMi41YS41LjUgMCAwIDEgLjUuNXptMS04YS41LjUgMCAwIDEgLS41LjVoLTNhLjUuNSAwIDAgMSAtLjUtLjV2LTNhLjUuNSAwIDAgMSAuNS0uNWgzYS41LjUgMCAwIDEgLjUuNXoiIGZpbGw9IiMzMDNjNDIiLz48L2c+PC9zdmc+'">
      </a>
      <div class="mod-details">
        <div class="mod-title">
          <a href="${
            mod.project_url
          }" target="_blank" rel="noopener noreferrer">${mod.title}</a>
          ${
            mod.isDependency
              ? `<span class="dependency-tooltip-container">
                   <span class="mod-title-tag dependency-tag">(Dependency)</span>
                   <span class="dependency-tooltip">Required by: ${dependencyMap.get(mod.projectId) || 'Unknown'}</span>
                 </span>`
              : ""
          }
        </div>
        <div class="mod-author">
          by <a href="${
            mod.author_url
          }" target="_blank" rel="noopener noreferrer">${mod.author_name}</a>
        </div>
        <div class="mod-description">${mod.description}</div>
        <div class="mod-meta">
          <div class="mod-meta-item">${
            clientServerInfo.svg
          }<span>${clientServerInfo.text}</span></div>
          <div class="mod-meta-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            <span class="mod-meta-date"></span>
          </div>
          <div class="mod-meta-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            <span>${formatDownloads(mod.downloads)}</span>
          </div>
          <div class="mod-meta-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            <span>${formatDownloads(mod.followers)}</span>
          </div>
          <div class="mod-meta-item category-tooltip-container" style="display: none;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 2H2v10l9.29 9.29a1 1 0 0 0 1.42 0l8-8a1 1 0 0 0 0-1.42L12 2z"></path>
              <path d="M7 7h.01"></path>
            </svg>
            <span class="category-tooltip"></span>
          </div>
          <div class="mod-meta-item changelog-toggle">Changelog</div>
          <div class="mod-meta-item list-view-channels">
            <a href="#" target="_blank" rel="noopener noreferrer" class="channel-link release" style="display: none;">Release</a>
            <a href="#" target="_blank" rel="noopener noreferrer" class="channel-link beta" style="display: none;">Beta</a>
            <a href="#" target="_blank" rel="noopener noreferrer" class="channel-link alpha" style="display: none;">Alpha</a>
          </div>
        </div>
      </div>
      <div class="mod-actions">
        <select class="version-select">${versionOptions}</select>
        <div class="grid-bottom-line">
          <div class="grid-view-channels">
            <a href="#" target="_blank" rel="noopener noreferrer" class="channel-link release" style="display: none;">Release</a>
            <a href="#" target="_blank" rel="noopener noreferrer" class="channel-link beta" style="display: none;">Beta</a>
            <a href="#" target="_blank" rel="noopener noreferrer" class="channel-link alpha" style="display: none;">Alpha</a>
          </div>
          <a href="#" class="download-link">Download</a>
        </div>
      </div>
    </div>
    <div class="changelog-content"></div>`;

  // Get references to ALL the elements we need to update
  const versionSelect = card.querySelector(".version-select");
  const downloadLink = card.querySelector(".download-link");
  const dateSpan = card.querySelector(".mod-meta-date");
  const changelogToggle = card.querySelector(".changelog-toggle");
  const changelogContent = card.querySelector(".changelog-content");

  // Get references to BOTH sets of links
  const listLinks = {
    release: card.querySelector(".list-view-channels .release"),
    beta: card.querySelector(".list-view-channels .beta"),
    alpha: card.querySelector(".list-view-channels .alpha"),
  };
  const gridLinks = {
    release: card.querySelector(".grid-view-channels .release"),
    beta: card.querySelector(".grid-view-channels .beta"),
    alpha: card.querySelector(".grid-view-channels .alpha"),
  };

  // --- Update Dynamic Content ---
  function updateDynamicContent() {
    const selectedVersionId = versionSelect.value;
    const selectedVersion = mod.all_versions.find(
      (v) => v.id === selectedVersionId
    );
    if (!selectedVersion) return;

    const primaryFile = selectedVersion.files.find((f) => f.primary);
    if (primaryFile) {
      downloadLink.href = primaryFile.url;
      downloadLink.setAttribute("download", primaryFile.filename);
    }
    dateSpan.textContent = formatTimeAgo(selectedVersion.date_published);
    changelogContent.innerHTML = marked.parse(
      selectedVersion.changelog || "No changelog provided for this version."
    );

    // Hide all links in both sets first
    Object.values(listLinks).forEach((link) => (link.style.display = "none"));
    Object.values(gridLinks).forEach((link) => (link.style.display = "none"));

    const versionUrl = `${mod.project_url}/version/${selectedVersion.version_number}`;
    const versionType = selectedVersion.version_type; // 'release', 'beta', or 'alpha'

    // Update the correct link in BOTH sets
    if (listLinks[versionType] && gridLinks[versionType]) {
      listLinks[versionType].href = versionUrl;
      listLinks[versionType].style.display = "inline";
      gridLinks[versionType].href = versionUrl;
      gridLinks[versionType].style.display = "inline";
    }
  }

  versionSelect.addEventListener("change", updateDynamicContent);
  changelogToggle.addEventListener("click", () => {
    changelogContent.classList.toggle("visible");
  });

  updateDynamicContent();

// --- Handle the "Already Updated" state ---
if (mod.isUpToDate) {
  const titleElement = card.querySelector(".mod-title");
  const tag = document.createElement("span");
  tag.className = "mod-title-tag"; // Use the new shared class
  tag.textContent = "(Already Updated)"; // Use the shorter text
  titleElement.appendChild(tag);
}

// --- Populate Category Tooltip ---
if (mod.categories && mod.categories.length > 0) {
  const categoryContainer = card.querySelector(".category-tooltip-container");
  const categoryTooltip = card.querySelector(".category-tooltip");

  // This helper function turns a slug like "world-gen" into "World Gen"
  function formatCategoryName(slug) {
    return slug
      .split("-")
      .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
      .join(" ");
  }

  // We map over the array of string slugs and format each one
  const formattedCategories = mod.categories.map(formatCategoryName);
  categoryTooltip.textContent = formattedCategories.join(", ");

  // Now that it's populated, make the icon visible
  categoryContainer.style.display = "flex";
}

return card;
}

// --- Create Warning Card ---
function createWarningCard(mod) {
  const card = document.createElement("div");
  // We keep the 'warning' class for the yellow border
  card.className = "result-card warning";
  const clientServerInfo = getClientServerSupport(
    mod.client_side,
    mod.server_side
  );

  card.innerHTML = `
    <div class="result-card-main">
      <a href="${mod.project_url}" target="_blank" rel="noopener noreferrer" class="mod-icon-link">
        <img src="${mod.icon_url}" alt="${mod.title} icon" class="mod-icon" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgaWQ9Ik1pbmVjcmFmdCI+PHBhdGggZD0ibTIxIDFoLTE4YTIgMiAwIDAgMCAtMiAydjE4YTIgMiAwIDAgMCAyIDJoMThhMiAyIDAgMCAwIDItMnYtMThhMiAyIDAgMCAwIC0yLTJ6bS0xNSA4LjV2LTNhLjUuNSAwIDAgMSAuNS0uNWgzYS41LjUgMCAwIDEgLjUuNXYzYS41LjUgMCAwIDEgLS41LjVoLTNhLjUuNSAwIDAgMSAtLjUtLjV6bTExIDhhLjUuNSAwIDAgMSAtLjUuNWgtMmEuNS41IDAgMCAxIC0uNS0uNXYtMS41aC00djEuNWEuNS41IDAgMCAxIC0uNS41aC0yYS41LjUgMCAwIDEgLS41LS41di01YS41LjUgMCAwIDEgLjUtLjVoMi41di0xLjVhLjUuNSAwIDAgMSAuNS0uNWgzYS41LjUgMCAwIDEgLjUuNXYxLjVoMi41YS41LjUgMCAwIDEgLjUuNXptMS04YS41LjUgMCAwIDEgLS41LjVoLTNhLjUuNSAwIDAgMSAtLjUtLjV2LTNhLjUuNSAwIDAgMSAuNS0uNWgzYS41LjUgMCAwIDEgLjUuNXoiIGZpbGw9IiMzMDNjNDIiLz48L2c+PC9zdmc+'">
      </a>
      <div class="mod-details">
        <div class="mod-title">
          <a href="${mod.project_url}" target="_blank" rel="noopener noreferrer">${mod.title}</a>
          <span class="mod-author">by <a href="${mod.author_url}" target="_blank" rel="noopener noreferrer">${mod.author_name}</a></span>
        </div>
        <div class="mod-description">${mod.description}</div>
        <div class="mod-meta">
          <div class="mod-meta-item">${clientServerInfo.svg}<span>${clientServerInfo.text}</span></div>
          <div class="mod-meta-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            <span>${formatDownloads(mod.downloads)}</span>
          </div>
        </div>
      </div>
    </div>
    <div class="changelog-content" style="width: 100%; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); display: block;">
       <p style="color: var(--warning-color); font-weight: bold; margin: 0;">${mod.reason}</p>
    </div>`;
  return card;
}

// --- Create Failure Card ---
function createFailureCard(mod) {
        const card = document.createElement("div");
        card.className = "result-card failure";
        card.innerHTML = `
          <div class="mod-details">
            <div class="mod-title">${mod.title}</div>
            <div class="mod-description">${mod.reason}</div>
          </div>`;
        return card;
      }

// --- Helper Functions ---



      // --- File Hash Calculation ---
      async function calculateFileHash(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const binary = event.target.result;
              const wordArray = CryptoJS.lib.WordArray.create(binary);
              const hash = CryptoJS.SHA1(wordArray).toString(CryptoJS.enc.Hex);
              resolve(hash);
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = (error) => reject(error);
          reader.readAsArrayBuffer(file);
        });
      }

      // --- Get Client/Server Support ---
      function getClientServerSupport(client, server) {
        const both =
          '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><path d="M9 2v20"></path></svg>';
        const clientIcon =
          '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"></rect><path d="M8 21h8"></path><path d="M12 17v4"></path></svg>';
        const serverIcon =
          '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2"></rect><rect x="2" y="14" width="20" height="8" rx="2"></rect><path d="M6 6h.01"></path><path d="M6 18h.01"></path></svg>';

        if (client !== "unsupported" && server !== "unsupported") {
          return { text: "Client & Server", svg: both };
        } else if (client !== "unsupported") {
          return { text: "Client-side", svg: clientIcon };
        } else if (server !== "unsupported") {
          return { text: "Server-side", svg: serverIcon };
        }
        return { text: "Unknown", svg: "" };
      }

      // --- Format Downloads ---
      function formatDownloads(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + "M";
        if (num >= 1000) return (num / 1000).toFixed(1) + "K";
        return num;
      }

      // --- Format Time Ago ---
      function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const seconds = Math.round((now - date) / 1000);
        const minutes = Math.round(seconds / 60);
        const hours = Math.round(minutes / 60);
        const days = Math.round(hours / 24);
        const months = Math.round(days / 30.44);
        const years = Math.round(days / 365.25);
        if (seconds < 60) return `${seconds}s ago`;
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days < 30) return `${days}d ago`;
        if (months < 12) return `${months}mo ago`;
        return `${years}y ago`;
      }

      // --- Create Modpack ---
      function createModpack() {
        // Get custom modpack name and version from user
        const packName = prompt("Enter modpack name:", "My Awesome Pack");
        if (packName === null) return; // User cancelled
        
        const packVersion = prompt("Enter modpack version:", "1.0.0");
        if (packVersion === null) return; // User cancelled
        
        // Clean the pack name for filename (remove invalid characters, keep spaces)
        const cleanPackName = packName.replace(/[<>:"/\\|?*]/g, "-");
        const filename = `${cleanPackName}-v${packVersion}.mrpack`;
        
        const loaderNameMap = {
          fabric: "fabric-loader",
          forge: "forge",
          quilt: "quilt-loader",
          neoforge: "neoforge",
        };

        const selectedLoader = modLoaderSelect.value;
        const officialLoaderName = loaderNameMap[selectedLoader] || selectedLoader;

        const manifest = {
          formatVersion: 1,
          game: "minecraft",
          versionId: `${cleanPackName.toLowerCase().replace(/\s+/g, "-")}-${packVersion}`,
          name: packName,
          version: packVersion,
          dependencies: {
            minecraft: mcVersionSelect.value,
            [officialLoaderName]: "*",
          },
          // --- BUILD THE FULL FILE ENTRY ---
          files: successfulDownloads.map((dl) => {
            const fileEntry = {
              path: dl.path,
              hashes: dl.hashes,
              downloads: [dl.url],
              fileSize: dl.fileSize, // Add the fileSize
            };

            // Conditionally build the env object
            const env = {};
            if (dl.client_side === "required") {
              env.client = "required";
            }
            if (dl.server_side === "required") {
              env.server = "required";
            }

            // Add the env object only if it has keys
            if (Object.keys(env).length > 0) {
              fileEntry.env = env;
            }

            return fileEntry;
          }),
        };

        const zip = new JSZip();
        zip.file("modrinth.index.json", JSON.stringify(manifest, null, 2));
        zip.folder("overrides");

        zip.generateAsync({ type: "blob" }).then(function (content) {
          const link = document.createElement("a");
          link.href = URL.createObjectURL(content);
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });
      }

      function formatBytes(bytes, decimals = 2) {
        if (!+bytes) return "0 Bytes";

        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ["Bytes", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB"];

        const i = Math.floor(Math.log(bytes) / Math.log(k));

        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
      }
    </script>
  </body>
</html>